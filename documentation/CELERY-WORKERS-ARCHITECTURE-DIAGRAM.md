# Celery Workers Architecture Diagram - Onyx

## ğŸ¯ Overview

This diagram shows how the 6 Celery background workers operate in Onyx, their communication flows, and how they solve the "API server can't talk to model server" issue.

---

## ğŸ—ï¸ Complete Celery Workers Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸŒ USER INTERFACE LAYER                                              â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   User Uploads  â”‚    â”‚   User Searches â”‚    â”‚   User Chats    â”‚    â”‚   Admin Tasks   â”‚              â”‚
â”‚  â”‚   Document      â”‚    â”‚   Documents     â”‚    â”‚   with LLM      â”‚    â”‚   (Connectors)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ“¡ NGINX GATEWAY                                                     â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              nginx:80 (Reverse Proxy)                                           â”‚   â”‚
â”‚  â”‚  Routes: / â†’ web-server:3000, /api/* â†’ api-server:8080                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ–¥ï¸ APPLICATION LAYER                                                 â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚        WEB SERVER               â”‚              â”‚        API SERVER               â”‚                  â”‚
â”‚  â”‚     (Next.js Frontend)          â”‚              â”‚      (FastAPI Backend)          â”‚                  â”‚
â”‚  â”‚                                 â”‚              â”‚                                 â”‚                  â”‚
â”‚  â”‚  â€¢ Serves UI                    â”‚              â”‚  â€¢ Handles user requests        â”‚                  â”‚
â”‚  â”‚  â€¢ User authentication          â”‚              â”‚  â€¢ Creates Celery tasks        â”‚                  â”‚
â”‚  â”‚  â€¢ Document upload UI           â”‚              â”‚  â€¢ Uses Inference Model Server â”‚                  â”‚
â”‚  â”‚  â€¢ Search interface             â”‚              â”‚  â€¢ Stores files in MinIO       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    âš¡ REDIS TASK QUEUE                                                   â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              Redis:6379 (Message Broker)                                        â”‚   â”‚
â”‚  â”‚                                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚   celery    â”‚  â”‚docprocessingâ”‚  â”‚docfetching  â”‚  â”‚   light     â”‚  â”‚   heavy     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚   queue     â”‚  â”‚   queue     â”‚  â”‚   queue     â”‚  â”‚   queue     â”‚  â”‚   queue     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Core tasksâ”‚  â”‚ â€¢ Doc index â”‚  â”‚ â€¢ Fetch docsâ”‚  â”‚ â€¢ Metadata  â”‚  â”‚ â€¢ Pruning   â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Periodic  â”‚  â”‚ â€¢ Embedding â”‚  â”‚ â€¢ Connectorsâ”‚  â”‚ â€¢ Permissionsâ”‚  â”‚ â€¢ Bulk sync â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ”„ CELERY WORKERS LAYER                                              â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CELERY BEAT   â”‚  â”‚ PRIMARY WORKER  â”‚  â”‚  LIGHT WORKER   â”‚  â”‚  HEAVY WORKER   â”‚  â”‚ DOCFETCHING     â”‚ â”‚
â”‚  â”‚   (Scheduler)   â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ WORKER          â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚ Queues:         â”‚  â”‚ Queues:         â”‚  â”‚ Queues:         â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ Schedules     â”‚  â”‚ â€¢ celery        â”‚  â”‚ â€¢ vespa_metadataâ”‚  â”‚ â€¢ connector_    â”‚  â”‚ Queues:         â”‚ â”‚
â”‚  â”‚   periodic      â”‚  â”‚ â€¢ periodic_tasksâ”‚  â”‚   _sync         â”‚  â”‚   pruning       â”‚  â”‚ â€¢ docfetching   â”‚ â”‚
â”‚  â”‚   tasks         â”‚  â”‚                 â”‚  â”‚ â€¢ connector_    â”‚  â”‚ â€¢ connector_    â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ Every 15s-5minâ”‚  â”‚ â€¢ Core tasks    â”‚  â”‚   deletion      â”‚  â”‚   doc_perms_    â”‚  â”‚ â€¢ Fetches docs  â”‚ â”‚
â”‚  â”‚ â€¢ 1 replica     â”‚  â”‚ â€¢ System mgmt   â”‚  â”‚ â€¢ doc_perms_    â”‚  â”‚   sync          â”‚  â”‚   from external â”‚ â”‚
â”‚  â”‚   (critical!)   â”‚  â”‚                 â”‚  â”‚   upsert        â”‚  â”‚ â€¢ external_     â”‚  â”‚   connectors    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ â€¢ checkpoint_   â”‚  â”‚   group_sync    â”‚  â”‚ â€¢ Google Drive  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   cleanup       â”‚  â”‚ â€¢ csv_generationâ”‚  â”‚ â€¢ Confluence    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ â€¢ index_attempt â”‚  â”‚                 â”‚  â”‚ â€¢ SharePoint    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   _cleanup      â”‚  â”‚                 â”‚  â”‚ â€¢ etc.          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            DOCPROCESSING WORKER (CRITICAL!)                                     â”‚   â”‚
â”‚  â”‚                                                                                                 â”‚   â”‚
â”‚  â”‚  Queue: docprocessing                                                                           â”‚   â”‚
â”‚  â”‚                                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                    DOCUMENT PROCESSING PIPELINE                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  1. Receive task from Redis queue                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  2. Download document from MinIO                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  3. Extract text from document (PDF, Word, etc.)                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  4. Chunk document into paragraphs (~512 tokens each)                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  5. For each chunk:                                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     a. Call INDEXING MODEL SERVER                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     b. Get embedding vector (768 dimensions)                                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     c. Store chunk + embedding in Vespa                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  6. Update PostgreSQL metadata                                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     â†“                                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  7. Mark task as complete                                                               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ¤– AI/ML MODEL SERVERS                                               â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚    INFERENCE MODEL SERVER       â”‚              â”‚    INDEXING MODEL SERVER        â”‚                  â”‚
â”‚  â”‚                                 â”‚              â”‚                                 â”‚                  â”‚
â”‚  â”‚  â€¢ Used by: API Server          â”‚              â”‚  â€¢ Used by: Docprocessing Workerâ”‚                  â”‚
â”‚  â”‚  â€¢ Purpose: Real-time queries   â”‚              â”‚  â€¢ Purpose: Bulk document       â”‚                  â”‚
â”‚  â”‚  â€¢ Port: 9000                   â”‚              â”‚    embedding                    â”‚                  â”‚
â”‚  â”‚  â€¢ Model: sentence-transformers â”‚              â”‚  â€¢ Port: 9000                   â”‚                  â”‚
â”‚  â”‚  â€¢ Input: User search queries   â”‚              â”‚  â€¢ Model: sentence-transformers â”‚                  â”‚
â”‚  â”‚  â€¢ Output: Query embeddings     â”‚              â”‚  â€¢ Input: Document chunks       â”‚                  â”‚
â”‚  â”‚                                 â”‚              â”‚  â€¢ Output: Chunk embeddings     â”‚                  â”‚
â”‚  â”‚  Example:                       â”‚              â”‚                                 â”‚                  â”‚
â”‚  â”‚  User: "vacation policy"        â”‚              â”‚  Example:                       â”‚                  â”‚
â”‚  â”‚  â†’ Embedding: [0.1, 0.2, ...]  â”‚              â”‚  Chunk: "Employees get 15 days"â”‚                  â”‚
â”‚  â”‚                                 â”‚              â”‚  â†’ Embedding: [0.3, 0.4, ...]  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ’¾ DATA STORAGE LAYER                                                â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   POSTGRESQL    â”‚  â”‚     VESPA       â”‚  â”‚     MINIO       â”‚  â”‚     REDIS       â”‚                  â”‚
â”‚  â”‚   (Metadata)    â”‚  â”‚  (Vector DB)    â”‚  â”‚ (File Storage)  â”‚  â”‚   (Cache)       â”‚                  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚                  â”‚
â”‚  â”‚ â€¢ User accounts â”‚  â”‚ â€¢ Document      â”‚  â”‚ â€¢ Original      â”‚  â”‚ â€¢ Task queue    â”‚                  â”‚
â”‚  â”‚ â€¢ Document      â”‚  â”‚   chunks        â”‚  â”‚   files         â”‚  â”‚ â€¢ Session data  â”‚                  â”‚
â”‚  â”‚   metadata      â”‚  â”‚ â€¢ Embeddings    â”‚  â”‚ â€¢ Processed     â”‚  â”‚ â€¢ API cache     â”‚                  â”‚
â”‚  â”‚ â€¢ Connector     â”‚  â”‚ â€¢ Search index  â”‚  â”‚   documents     â”‚  â”‚ â€¢ Rate limiting â”‚                  â”‚
â”‚  â”‚   configs       â”‚  â”‚ â€¢ Vector        â”‚  â”‚ â€¢ Images        â”‚  â”‚                 â”‚                  â”‚
â”‚  â”‚ â€¢ Chat history  â”‚  â”‚   similarity    â”‚  â”‚ â€¢ Exports       â”‚  â”‚                 â”‚                  â”‚
â”‚  â”‚ â€¢ Permissions   â”‚  â”‚ â€¢ Metadata      â”‚  â”‚                 â”‚  â”‚                 â”‚                  â”‚
â”‚  â”‚                 â”‚  â”‚   filtering     â”‚  â”‚                 â”‚  â”‚                 â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Detailed Communication Flows

### 1. Document Upload & Indexing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DOCUMENT UPLOAD & INDEXING FLOW                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER UPLOADS DOCUMENT
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User selects    â”‚
   â”‚ "HR_Policy.pdf" â”‚
   â”‚ via Onyx UI     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
2. WEB SERVER â†’ API SERVER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/upload                                                                                â”‚
   â”‚ Content-Type: multipart/form-data                                                               â”‚
   â”‚ File: HR_Policy.pdf                                                                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
3. API SERVER PROCESSES UPLOAD
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1. Validate file type and size                                                                  â”‚
   â”‚ 2. Upload to MinIO:                                                                             â”‚
   â”‚    PUT /onyx-file-store-bucket/HR_Policy.pdf                                                    â”‚
   â”‚ 3. Create database record:                                                                      â”‚
   â”‚    INSERT INTO documents (id, name, status, created_at)                                         â”‚
   â”‚    VALUES ('doc-123', 'HR_Policy.pdf', 'pending', NOW())                                        â”‚
   â”‚ 4. Create Celery task:                                                                          â”‚
   â”‚    task = process_document.delay('doc-123')                                                     â”‚
   â”‚ 5. Return 200 OK to user                                                                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
4. TASK QUEUED IN REDIS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Redis Queue: docprocessing                                                                      â”‚
   â”‚                                                                                                 â”‚
   â”‚ LPUSH docprocessing {                                                                           â”‚
   â”‚   "task": "process_document",                                                                   â”‚
   â”‚   "args": ["doc-123"],                                                                          â”‚
   â”‚   "id": "task-456",                                                                             â”‚
   â”‚   "retries": 0                                                                                  â”‚
   â”‚ }                                                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
5. DOCPROCESSING WORKER PICKS UP TASK
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Worker: celery-worker-docprocessing                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ 1. Polls Redis queue: BRPOP docprocessing                                                       â”‚
   â”‚ 2. Receives task: process_document('doc-123')                                                   â”‚
   â”‚ 3. Starts processing...                                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
6. DOCUMENT PROCESSING PIPELINE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Step 1: Download from MinIO                                                                     â”‚
   â”‚   GET /onyx-file-store-bucket/HR_Policy.pdf                                                     â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 2: Extract text                                                                            â”‚
   â”‚   - Use PyPDF2/pdfplumber for PDFs                                                              â”‚
   â”‚   - Use python-docx for Word docs                                                               â”‚
   â”‚   - Extract plain text content                                                                  â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 3: Chunk document                                                                          â”‚
   â”‚   - Split into paragraphs (~512 tokens each)                                                    â”‚
   â”‚   - Preserve context and metadata                                                               â”‚
   â”‚   - Create chunk IDs                                                                            â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 4: Generate embeddings (FOR EACH CHUNK)                                                    â”‚
   â”‚   POST http://indexing-model-server:9000/embed                                                  â”‚
   â”‚   {                                                                                             â”‚
   â”‚     "text": "Employees are entitled to 15 days of vacation...",                                 â”‚
   â”‚     "model": "sentence-transformers/all-MiniLM-L6-v2"                                           â”‚
   â”‚   }                                                                                             â”‚
   â”‚   Response: {                                                                                   â”‚
   â”‚     "embedding": [0.123, 0.456, 0.789, ...]  // 768 dimensions                                 â”‚
   â”‚   }                                                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 5: Store in Vespa                                                                          â”‚
   â”‚   PUT http://vespa:19071/document/v1/onyx/document/doc-123-chunk-1                             â”‚
   â”‚   {                                                                                             â”‚
   â”‚     "fields": {                                                                                 â”‚
   â”‚       "id": "doc-123-chunk-1",                                                                  â”‚
   â”‚       "title": "HR Policy - Vacation",                                                          â”‚
   â”‚       "content": "Employees are entitled to 15 days...",                                        â”‚
   â”‚       "embedding": [0.123, 0.456, 0.789, ...],                                                 â”‚
   â”‚       "document_id": "doc-123",                                                                 â”‚
   â”‚       "chunk_index": 1,                                                                         â”‚
   â”‚       "created_at": "2025-10-21T10:00:00Z"                                                     â”‚
   â”‚     }                                                                                           â”‚
   â”‚   }                                                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 6: Update PostgreSQL                                                                       â”‚
   â”‚   UPDATE documents                                                                              â”‚
   â”‚   SET status = 'indexed',                                                                       â”‚
   â”‚       indexed_at = NOW(),                                                                       â”‚
   â”‚       chunk_count = 5                                                                           â”‚
   â”‚   WHERE id = 'doc-123'                                                                          â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 7: Mark task complete                                                                      â”‚
   â”‚   - Update task status in Redis                                                                 â”‚
   â”‚   - Log completion                                                                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
7. DOCUMENT READY FOR SEARCH!
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Status: âœ… INDEXED                                                                              â”‚
   â”‚                                                                                                 â”‚
   â”‚ - 5 chunks created                                                                              â”‚
   â”‚ - 5 embeddings generated                                                                        â”‚
   â”‚ - Stored in Vespa                                                                               â”‚
   â”‚ - Metadata in PostgreSQL                                                                        â”‚
   â”‚ - Ready for semantic search                                                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Search Query Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    SEARCH QUERY FLOW                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER SEARCHES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User types:     â”‚
   â”‚ "vacation days" â”‚
   â”‚ in search box   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
2. WEB SERVER â†’ API SERVER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/query                                                                                â”‚
   â”‚ {                                                                                              â”‚
   â”‚   "query": "vacation days",                                                                    â”‚
   â”‚   "filters": {},                                                                               â”‚
   â”‚   "limit": 10                                                                                  â”‚
   â”‚ }                                                                                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
3. API SERVER PROCESSES QUERY
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Step 1: Generate query embedding                                                               â”‚
   â”‚   POST http://inference-model-server:9000/embed                                                â”‚
   â”‚   {                                                                                             â”‚
   â”‚     "text": "vacation days",                                                                   â”‚
   â”‚     "model": "sentence-transformers/all-MiniLM-L6-v2"                                          â”‚
   â”‚   }                                                                                             â”‚
   â”‚   Response: {                                                                                   â”‚
   â”‚     "embedding": [0.111, 0.222, 0.333, ...]  // 768 dimensions                                â”‚
   â”‚   }                                                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 2: Search Vespa                                                                           â”‚
   â”‚   POST http://vespa:19071/search/                                                               â”‚
   â”‚   {                                                                                             â”‚
   â”‚     "yql": "select * from sources * where {targetHits:10}nearestNeighbor(embedding,query_vector)",â”‚
   â”‚     "query_vector": [0.111, 0.222, 0.333, ...],                                               â”‚
   â”‚     "ranking": "semantic_similarity"                                                            â”‚
   â”‚   }                                                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 3: Get results                                                                            â”‚
   â”‚   Response: {                                                                                   â”‚
   â”‚     "root": {                                                                                   â”‚
   â”‚       "children": [                                                                             â”‚
   â”‚         {                                                                                       â”‚
   â”‚           "fields": {                                                                           â”‚
   â”‚             "id": "doc-123-chunk-1",                                                            â”‚
   â”‚             "title": "HR Policy - Vacation",                                                    â”‚
   â”‚             "content": "Employees are entitled to 15 days of vacation...",                     â”‚
   â”‚             "relevance": 0.95                                                                   â”‚
   â”‚           }                                                                                     â”‚
   â”‚         }                                                                                       â”‚
   â”‚       ]                                                                                         â”‚
   â”‚     }                                                                                           â”‚
   â”‚   }                                                                                             â”‚
   â”‚                                                                                                 â”‚
   â”‚ Step 4: Return results to user                                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
4. USER SEES RESULTS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Search Results for "vacation days":                                                            â”‚
   â”‚                                                                                                 â”‚
   â”‚ ğŸ“„ HR Policy - Vacation (95% match)                                                            â”‚
   â”‚ "Employees are entitled to 15 days of vacation per year..."                                    â”‚
   â”‚                                                                                                 â”‚
   â”‚ ğŸ“„ Employee Handbook (87% match)                                                               â”‚
   â”‚ "Vacation requests must be submitted at least 2 weeks..."                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Connector Sync Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CONNECTOR SYNC FLOW                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. CELERY BEAT SCHEDULER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Every 1 hour: Check for connector sync tasks                                                    â”‚
   â”‚                                                                                                 â”‚
   â”‚ 1. Query PostgreSQL:                                                                            â”‚
   â”‚    SELECT * FROM connectors WHERE enabled = true AND last_sync < NOW() - INTERVAL '1 hour'    â”‚
   â”‚                                                                                                 â”‚
   â”‚ 2. For each connector, create sync task:                                                        â”‚
   â”‚    task = sync_connector.delay(connector_id=5)                                                  â”‚
   â”‚                                                                                                 â”‚
   â”‚ 3. Queue task in Redis:                                                                         â”‚
   â”‚    LPUSH docfetching {                                                                          â”‚
   â”‚      "task": "sync_connector",                                                                  â”‚
   â”‚      "args": [5],                                                                               â”‚
   â”‚      "id": "sync-task-789"                                                                      â”‚
   â”‚    }                                                                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
2. DOCFETCHING WORKER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Worker: celery-worker-docfetching                                                               â”‚
   â”‚                                                                                                 â”‚
   â”‚ 1. Polls Redis: BRPOP docfetching                                                               â”‚
   â”‚ 2. Receives: sync_connector(5)                                                                  â”‚
   â”‚ 3. Fetches connector config from PostgreSQL                                                     â”‚
   â”‚ 4. Authenticates to external service (Google Drive, Confluence, etc.)                          â”‚
   â”‚ 5. Lists new/updated files since last sync                                                      â”‚
   â”‚ 6. For each file, creates docprocessing task:                                                   â”‚
   â”‚    task = process_document.delay(file_id, connector_id=5)                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
3. DOCPROCESSING WORKER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ (Same as document upload flow above)                                                            â”‚
   â”‚                                                                                                 â”‚
   â”‚ 1. Download file from external service                                                          â”‚
   â”‚ 2. Upload to MinIO                                                                              â”‚
   â”‚ 3. Extract text                                                                                 â”‚
   â”‚ 4. Chunk document                                                                               â”‚
   â”‚ 5. Call INDEXING MODEL SERVER for embeddings                                                    â”‚
   â”‚ 6. Store in Vespa                                                                               â”‚
   â”‚ 7. Update PostgreSQL metadata                                                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Worker Configuration Details

### Celery Beat (Scheduler)
```yaml
# File: 10-celery-beat.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.beat
  - beat
  - --loglevel=INFO

# CRITICAL: Must be exactly 1 replica
replicas: 1

# Schedules:
# - Every 15s: Check for indexing tasks
# - Every 20s: Check for connector sync
# - Every 1min: Check for pruning tasks
# - Every 5min: System health checks
```

### Primary Worker
```yaml
# File: 11-celery-worker-primary.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.primary
  - worker
  - --loglevel=INFO
  - --hostname=primary@%n
  - -Q
  - celery,periodic_tasks

# Queues:
# - celery: Default queue for general tasks
# - periodic_tasks: Tasks scheduled by Beat

# Tasks:
# - Connector deletion
# - Vespa sync operations
# - LLM model updates
# - System-wide operations
```

### Light Worker
```yaml
# File: 12-celery-worker-light.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.light
  - worker
  - --loglevel=INFO
  - --hostname=light@%n
  - -Q
  - vespa_metadata_sync,connector_deletion,doc_permissions_upsert,checkpoint_cleanup,index_attempt_cleanup

# Queues:
# - vespa_metadata_sync: Sync Vespa metadata
# - connector_deletion: Delete connectors
# - doc_permissions_upsert: Update document permissions
# - checkpoint_cleanup: Clean up indexing checkpoints
# - index_attempt_cleanup: Clean up failed indexing attempts
```

### Heavy Worker
```yaml
# File: 13-celery-worker-heavy.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.heavy
  - worker
  - --loglevel=INFO
  - --hostname=heavy@%n
  - -Q
  - connector_pruning,connector_doc_permissions_sync,connector_external_group_sync,csv_generation

# Queues:
# - connector_pruning: Prune deleted documents
# - connector_doc_permissions_sync: Sync document permissions
# - connector_external_group_sync: Sync external groups
# - csv_generation: Generate CSV exports

# High resource usage for bulk operations
resources:
  requests:
    cpu: 1000m
    memory: 4Gi
  limits:
    cpu: 2000m
    memory: 8Gi
```

### Docfetching Worker
```yaml
# File: 14-celery-worker-docfetching.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.docfetching
  - worker
  - --pool=threads
  - --concurrency=4
  - --loglevel=INFO
  - --hostname=docfetching@%n
  - -Q
  - docfetching

# Special configuration:
# - --pool=threads: Uses thread pool for I/O-bound operations
# - --concurrency=4: 4 concurrent threads

# Tasks:
# - Fetch documents from Google Drive
# - Fetch documents from Confluence
# - Fetch documents from SharePoint
# - Fetch documents from other connectors
```

### Docprocessing Worker (CRITICAL!)
```yaml
# File: 15-celery-worker-docprocessing.yaml
command:
  - celery
  - -A
  - onyx.background.celery.versioned_apps.docprocessing
  - worker
  - --pool=threads
  - --concurrency=6
  - --prefetch-multiplier=1
  - --loglevel=INFO
  - --hostname=docprocessing@%n
  - -Q
  - docprocessing

# Special configuration:
# - --pool=threads: Uses thread pool for embedding operations
# - --concurrency=6: 6 concurrent threads
# - --prefetch-multiplier=1: Process one task at a time per thread

# CRITICAL OPERATIONS:
# 1. Download document from MinIO
# 2. Extract text content
# 3. Chunk document into paragraphs
# 4. Call INDEXING MODEL SERVER for each chunk
# 5. Store chunks + embeddings in Vespa
# 6. Update PostgreSQL metadata

# High resource usage for embedding generation
resources:
  requests:
    cpu: 1000m
    memory: 8Gi
  limits:
    cpu: 4000m
    memory: 16Gi
```

---

## ğŸ¯ Why This Solves the "API Server Can't Talk to Model Server" Issue

### The Misunderstanding
**What you thought:**
- API server should talk to both Inference and Indexing model servers
- Problem must be network/DNS/configuration

**What actually happens:**

### API Server Responsibilities
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    API SERVER ROLE                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API SERVER (FastAPI Backend)                                                                          â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… USES INFERENCE MODEL SERVER                                                                        â”‚
â”‚     â€¢ Real-time query embedding                                                                        â”‚
â”‚     â€¢ User search queries                                                                              â”‚
â”‚     â€¢ Chat interactions                                                                                â”‚
â”‚     â€¢ Live embedding generation                                                                        â”‚
â”‚                                                                                                         â”‚
â”‚  âŒ DOES NOT USE INDEXING MODEL SERVER                                                                  â”‚
â”‚     â€¢ Not designed for bulk processing                                                                 â”‚
â”‚     â€¢ Would block user requests                                                                        â”‚
â”‚     â€¢ Not scalable for large documents                                                                 â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… CREATES CELERY TASKS                                                                                â”‚
â”‚     â€¢ Queues document processing tasks                                                                 â”‚
â”‚     â€¢ Queues connector sync tasks                                                                      â”‚
â”‚     â€¢ Queues cleanup tasks                                                                             â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… HANDLES USER REQUESTS                                                                               â”‚
â”‚     â€¢ Document uploads                                                                                 â”‚
â”‚     â€¢ Search queries                                                                                   â”‚
â”‚     â€¢ Chat interactions                                                                                â”‚
â”‚     â€¢ Admin operations                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Background Workers Responsibilities
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                BACKGROUND WORKERS ROLE                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKGROUND WORKERS (Celery)                                                                            â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… USES INDEXING MODEL SERVER                                                                          â”‚
â”‚     â€¢ Bulk document embedding                                                                           â”‚
â”‚     â€¢ Background processing                                                                             â”‚
â”‚     â€¢ Non-blocking operations                                                                           â”‚
â”‚     â€¢ Scalable for large documents                                                                      â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… PROCESSES DOCUMENTS                                                                                  â”‚
â”‚     â€¢ Downloads from MinIO                                                                              â”‚
â”‚     â€¢ Extracts text content                                                                             â”‚
â”‚     â€¢ Chunks documents                                                                                  â”‚
â”‚     â€¢ Generates embeddings                                                                              â”‚
â”‚     â€¢ Stores in Vespa                                                                                   â”‚
â”‚                                                                                                         â”‚
â”‚  âœ… HANDLES BACKGROUND TASKS                                                                             â”‚
â”‚     â€¢ Connector synchronization                                                                         â”‚
â”‚     â€¢ Document pruning                                                                                  â”‚
â”‚     â€¢ Metadata synchronization                                                                          â”‚
â”‚     â€¢ System maintenance                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Solution
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    THE SOLUTION                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BEFORE (Missing Workers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server    â”‚    â”‚ Indexing Model  â”‚    â”‚     Vespa       â”‚
â”‚                 â”‚    â”‚    Server       â”‚    â”‚                 â”‚
â”‚ Creates tasks   â”‚â”€â”€â”€â–¶â”‚                 â”‚    â”‚                 â”‚
â”‚ in Redis        â”‚    â”‚ NEVER USED!     â”‚    â”‚ EMPTY!          â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Tasks pile up   â”‚    â”‚ No workers to   â”‚    â”‚ No documents    â”‚
â”‚ forever         â”‚    â”‚ call it         â”‚    â”‚ indexed         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER (With Workers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server    â”‚    â”‚ Docprocessing   â”‚    â”‚ Indexing Model  â”‚    â”‚     Vespa       â”‚
â”‚                 â”‚    â”‚    Worker       â”‚    â”‚    Server       â”‚    â”‚                 â”‚
â”‚ Creates tasks   â”‚â”€â”€â”€â–¶â”‚                 â”‚â”€â”€â”€â–¶â”‚                 â”‚â”€â”€â”€â–¶â”‚                 â”‚
â”‚ in Redis        â”‚    â”‚ Picks up tasks  â”‚    â”‚ Generates       â”‚    â”‚ Stores chunks   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚ embeddings      â”‚    â”‚ + embeddings    â”‚
â”‚ Tasks processed â”‚    â”‚ Calls model     â”‚    â”‚ USED!           â”‚    â”‚ DOCUMENTS       â”‚
â”‚ immediately     â”‚    â”‚ server          â”‚    â”‚                 â”‚    â”‚ INDEXED!        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Resource Usage Summary

### Full Deployment (All 6 Workers)
| Worker | CPU Request | CPU Limit | Memory Request | Memory Limit | Purpose |
|--------|-------------|-----------|----------------|--------------|---------|
| Beat | 100m | 500m | 256Mi | 512Mi | Task scheduling |
| Primary | 500m | 1000m | 1Gi | 2Gi | Core tasks |
| Light | 500m | 1000m | 1Gi | 2Gi | Lightweight ops |
| Heavy | 1000m | 2000m | 4Gi | 8Gi | Resource-intensive |
| Docfetching | 500m | 2000m | 8Gi | 16Gi | Document fetching |
| Docprocessing | 1000m | 4000m | 8Gi | 16Gi | **Document indexing** |
| **TOTAL** | **3.6 cores** | **10.5 cores** | **22 GB** | **44 GB** | |

### Minimal Deployment (3 Critical Workers)
| Worker | CPU Request | CPU Limit | Memory Request | Memory Limit | Purpose |
|--------|-------------|-----------|----------------|--------------|---------|
| Beat | 100m | 500m | 256Mi | 512Mi | Task scheduling |
| Primary | 500m | 1000m | 1Gi | 2Gi | Core tasks |
| Docprocessing | 1000m | 4000m | 8Gi | 16Gi | **Document indexing** |
| **TOTAL** | **1.6 cores** | **5.5 cores** | **9.2 GB** | **18.5 GB** | |

---

## ğŸš€ Deployment Commands

### Full Deployment
```bash
# Deploy all 6 workers
oc apply -f manifests/10-celery-beat.yaml
oc apply -f manifests/11-celery-worker-primary.yaml
oc apply -f manifests/12-celery-worker-light.yaml
oc apply -f manifests/13-celery-worker-heavy.yaml
oc apply -f manifests/14-celery-worker-docfetching.yaml
oc apply -f manifests/15-celery-worker-docprocessing.yaml

# Wait for all workers to be ready
oc get pods -l scope=onyx-backend-celery -w
```

### Minimal Deployment (Resource-Constrained)
```bash
# Deploy only critical workers
oc apply -f manifests/10-celery-beat.yaml
oc apply -f manifests/11-celery-worker-primary.yaml
oc apply -f manifests/15-celery-worker-docprocessing.yaml

# Wait for workers to be ready
oc get pods -l scope=onyx-backend-celery -w
```

---

## ğŸ” Verification Steps

### 1. Check All Workers Running
```bash
oc get pods -l scope=onyx-backend-celery

# Expected output:
# NAME                                         READY   STATUS    RESTARTS   AGE
# celery-beat-xxx                              1/1     Running   0          2m
# celery-worker-primary-xxx                    1/1     Running   0          2m
# celery-worker-light-xxx                      1/1     Running   0          2m
# celery-worker-heavy-xxx                      1/1     Running   0          2m
# celery-worker-docfetching-xxx                1/1     Running   0          2m
# celery-worker-docprocessing-xxx              1/1     Running   0          2m
```

### 2. Check Worker Logs
```bash
# Check Beat scheduler
oc logs -l app=celery-beat --tail=20

# Check Primary worker
oc logs -l app=celery-worker-primary --tail=20

# Check Docprocessing worker (CRITICAL)
oc logs -l app=celery-worker-docprocessing --tail=20
```

### 3. Test Document Upload
```bash
# Upload a document via Onyx UI
# Then watch docprocessing worker logs

oc logs -l app=celery-worker-docprocessing --tail=100 -f

# Should see:
# "Task onyx.background.celery.tasks.indexing.upsert_documents[xxx] received"
# "Calling indexing model server at indexing-model-server.onyx-infra.svc.cluster.local:9000"
# "Received embeddings from model server"
# "Writing to Vespa..."
# "Task succeeded"
```

---

## ğŸ“š Key Takeaways

1. **API Server â‰  Background Workers**: API server handles user requests, workers handle background processing
2. **Two Model Servers, Two Purposes**: Inference for real-time queries, Indexing for bulk processing
3. **Redis is the Bridge**: API server creates tasks, workers consume tasks
4. **Docprocessing Worker is Critical**: This is the worker that calls the Indexing Model Server
5. **Without Workers**: Documents never get indexed, search returns no results
6. **With Workers**: Complete document processing pipeline works correctly

This architecture ensures that:
- User requests are handled quickly (API server + Inference Model Server)
- Background processing doesn't block user interactions (separate workers)
- Large documents can be processed efficiently (bulk processing with Indexing Model Server)
- System is scalable and resilient (multiple workers, task queues)
